<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AudioWorklet Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover {
      background-color: #45a049;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .log {
      margin-top: 20px;
      border: 1px solid #ddd;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <h1>AudioWorklet Test</h1>
  <p>This page tests if the AudioWorklet is working correctly.</p>
  
  <button id="testButton">Test AudioWorklet</button>
  <button id="playButton">Play Test Sound</button>
  
  <div class="log" id="log"></div>
  
  <script>
    const logElement = document.getElementById('log');
    
    function log(message) {
      const line = document.createElement('div');
      line.textContent = message;
      logElement.appendChild(line);
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    async function testAudioWorklet() {
      log('Starting AudioWorklet test...');
      
      try {
        // Create audio context
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        log(`Created AudioContext with sample rate: ${audioContext.sampleRate}Hz`);
        
        // Load worklet
        try {
          log('Loading AudioWorklet module...');
          await audioContext.audioWorklet.addModule('/musicVWorklet.js');
          log('AudioWorklet module loaded successfully!');
        } catch (error) {
          log(`Error loading AudioWorklet module: ${error.message}`);
          console.error('Error loading AudioWorklet:', error);
          return;
        }
        
        // Create worklet node
        try {
          log('Creating AudioWorkletNode...');
          const workletNode = new AudioWorkletNode(audioContext, 'music-v-processor');
          log('AudioWorkletNode created successfully!');
          
          // Connect to destination
          workletNode.connect(audioContext.destination);
          log('Connected to audio destination');
          
          // Send test message
          workletNode.port.postMessage({
            type: 'init',
            events: [
              { type: 'note', time: 0, insNum: 1, frequency: 440, amplitude: 0.5, duration: 1 }
            ],
            instruments: {
              '1': {
                id: 1,
                units: [
                  {
                    type: 'OSC',
                    params: {
                      freqParam: 'P5',
                      ampParam: 'P6',
                      outputBlock: 2,
                      functionNum: 2
                    }
                  },
                  {
                    type: 'OUT',
                    params: {
                      inputBlock: 2,
                      outputBlock: 1,
                      amplitude: 1.0
                    }
                  }
                ]
              }
            },
            functions: {
              '2': Array.from({ length: 512 }, (_, i) => Math.sin(2 * Math.PI * i / 512))
            },
            sampleRate: audioContext.sampleRate
          });
          log('Sent initialization message to AudioWorklet');
          
          // Resume audio context
          if (audioContext.state === 'suspended') {
            await audioContext.resume();
            log(`AudioContext resumed: ${audioContext.state}`);
          }
          
          log('Test completed successfully! You should hear a sine wave at 440Hz.');
          
          // Store for later use
          window.testWorkletNode = workletNode;
          window.testAudioContext = audioContext;
          
        } catch (error) {
          log(`Error creating AudioWorkletNode: ${error.message}`);
          console.error('Error creating AudioWorkletNode:', error);
        }
        
      } catch (error) {
        log(`Error: ${error.message}`);
        console.error('Test failed:', error);
      }
    }
    
    async function playTestSound() {
      log('Playing test sound...');
      
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        log(`Created AudioContext with sample rate: ${audioContext.sampleRate}Hz`);
        
        // Create oscillator
        const oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        
        // Create gain node
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
        
        // Connect nodes
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Start and stop oscillator
        oscillator.start();
        log('Test sound started (440Hz sine wave)');
        
        setTimeout(() => {
          oscillator.stop();
          log('Test sound stopped');
        }, 2000);
        
      } catch (error) {
        log(`Error playing test sound: ${error.message}`);
        console.error('Error playing test sound:', error);
      }
    }
    
    // Add event listeners
    document.getElementById('testButton').addEventListener('click', testAudioWorklet);
    document.getElementById('playButton').addEventListener('click', playTestSound);
    
    // Log initial message
    log('Page loaded. Click "Test AudioWorklet" to begin the test.');
  </script>
</body>
</html> 