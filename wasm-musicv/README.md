# MusicV WebAssembly Test

This is a simple test application that demonstrates compiling the original MusicV Fortran code to WebAssembly and running it in a browser.

## Project Structure

- `index.html` - The web interface for testing MusicV scores
- `musicv.js` - JavaScript code for interacting with the WebAssembly module
- `compile.sh` - Shell script to compile the Fortran code to WebAssembly
- `src/` - Directory containing the Fortran source files

## Prerequisites

To compile the Fortran code to WebAssembly, you'll need:

1. [Emscripten SDK](https://emscripten.org/docs/getting_started/downloads.html)
2. [Flang](https://github.com/flang-compiler/flang) or [gfortran](https://gcc.gnu.org/wiki/GFortran) with WebAssembly support

## Compilation Steps

### 1. Set up Emscripten

```bash
# Clone the Emscripten repository
git clone https://github.com/emscripten-core/emsdk.git

# Enter the directory
cd emsdk

# Download and install the latest SDK tools
./emsdk install latest

# Activate the latest SDK
./emsdk activate latest

# Set up the environment variables
source ./emsdk_env.sh
```

### 2. Prepare the Fortran Source Files

Copy the original MusicV Fortran source files to the `src` directory:

```bash
mkdir -p src
cp ../server/musicV/sources/pass1.f src/
cp ../server/musicV/sources/pass2.f src/
cp ../server/musicV/sources/pass3.f src/
```

### 3. Compile to WebAssembly

There are two main approaches to compile Fortran to WebAssembly:

#### Option 1: Using f2c + Emscripten

```bash
# Install f2c if not already installed
# On macOS: brew install f2c
# On Ubuntu: apt-get install f2c

# Convert Fortran to C
f2c src/pass1.f -o src/pass1.c
f2c src/pass2.f -o src/pass2.c
f2c src/pass3.f -o src/pass3.c

# Compile C to WebAssembly using Emscripten
emcc src/pass1.c src/pass2.c src/pass3.c -o musicv.js \
  -s WASM=1 \
  -s EXPORTED_FUNCTIONS='["_main", "_run_pass1", "_run_pass2", "_run_pass3"]' \
  -s EXPORTED_RUNTIME_METHODS='["ccall", "cwrap"]' \
  -s ALLOW_MEMORY_GROWTH=1 \
  -s FORCE_FILESYSTEM=1
```

#### Option 2: Using Flang + LLVM + Emscripten

This approach is more complex but may provide better results:

```bash
# Compile Fortran to LLVM IR
flang -c -emit-llvm src/pass1.f -o src/pass1.bc
flang -c -emit-llvm src/pass2.f -o src/pass2.bc
flang -c -emit-llvm src/pass3.f -o src/pass3.bc

# Link LLVM bitcode files
llvm-link src/pass1.bc src/pass2.bc src/pass3.bc -o musicv.bc

# Compile to WebAssembly using Emscripten
emcc musicv.bc -o musicv.js \
  -s WASM=1 \
  -s EXPORTED_FUNCTIONS='["_main", "_run_pass1", "_run_pass2", "_run_pass3"]' \
  -s EXPORTED_RUNTIME_METHODS='["ccall", "cwrap"]' \
  -s ALLOW_MEMORY_GROWTH=1 \
  -s FORCE_FILESYSTEM=1
```

## Running the Application

After compilation, you'll have:
- `musicv.wasm` - The WebAssembly binary
- `musicv.js` - JavaScript glue code generated by Emscripten

To run the application:

1. Start a local web server:
   ```bash
   python -m http.server
   ```

2. Open a browser and navigate to `http://localhost:8000`

3. Enter a MusicV score in the text area or use the default example

4. Click "Compile & Run" to process the score and generate audio

## Adapting the Fortran Code

The original MusicV Fortran code may need some adaptations to work properly with WebAssembly:

1. File I/O needs to be modified to work with Emscripten's virtual filesystem
2. Replace any system-specific calls with portable alternatives
3. Add wrapper functions to expose the functionality to JavaScript

## Current Status

This is a prototype implementation. The current version simulates the MusicV processing and generates placeholder audio. The actual WebAssembly compilation is a work in progress.

## Resources

- [Emscripten Documentation](https://emscripten.org/docs/index.html)
- [WebAssembly Documentation](https://webassembly.org/docs/overview/)
- [f2c Documentation](https://www.netlib.org/f2c/) 